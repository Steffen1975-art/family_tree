<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interaktiver Stammbaum - Familie Koller (Dynamisches Layout)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* General body styling */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            color: #1e293b;
            margin: 0;
            overflow: hidden; /* Prevent body scrollbars */
        }

        /* SVG container styling */
        #tree-container {
            width: 100vw;
            height: 100vh;
        }

        /* Styling for the connecting lines (links) */
        .link {
            fill: none;
            stroke: #94a3b8;
            stroke-width: 2px;
        }

        /* Styling for the person nodes (groups of circle and text) */
        .node {
            cursor: pointer;
            font-size: 14px;
        }

        .node circle {
            stroke: #0ea5e9;
            stroke-width: 2.5px;
            transition: fill 0.3s ease, transform 0.3s ease;
        }

        .node text {
            font-weight: 500;
            paint-order: stroke;
            stroke: #f8fafc;
            stroke-width: 3.5px;
            stroke-linecap: butt;
            stroke-linejoin: miter;
        }
        
        /* Highlight node on hover */
        .node:hover circle {
            transform: scale(1.1);
        }
        
        /* Controls for layout switching */
        .controls {
            position: absolute;
            top: 1rem;
            right: 1rem;
            z-index: 20;
            background-color: white;
            padding: 0.75rem;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            display: flex;
            flex-direction: column;
            gap: 0.75rem; /* Increased gap */
        }

        .controls .control-group {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .controls label {
            margin-right: 0.75rem;
            font-size: 0.875rem;
            font-weight: 500;
            white-space: nowrap;
        }

        .controls select {
            border-radius: 6px;
            border: 1px solid #d1d5db;
            padding: 0.25rem 0.5rem;
            width: 110px; /* Give select a fixed width */
        }

        /* Tooltip for displaying details on hover */
        .tooltip {
            position: absolute;
            text-align: left;
            padding: 12px;
            font-size: 0.875rem;
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            pointer-events: none; /* Allows mouse events to pass through */
            opacity: 0;
            transition: opacity 0.3s;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            max-width: 300px;
            z-index: 10;
        }

        .tooltip .name {
            font-weight: 700;
            color: #0c4a6e; /* text-sky-900 */
            font-size: 1rem;
            margin-bottom: 8px;
        }

        .tooltip .details p {
            margin: 4px 0;
        }

        .tooltip .details strong {
            color: #334155; /* text-slate-700 */
        }

    </style>
</head>
<body>

    <!-- Header Section -->
    <div class="absolute top-0 left-0 p-4 md:p-6 z-10 w-full bg-gradient-to-b from-white via-white/80 to-transparent pointer-events-none">
        <h1 class="text-2xl md:text-3xl font-bold text-sky-800">Ahnengalerie der Familie Koller</h1>
        <p class="text-slate-600 mt-1 text-sm md:text-base">Knoten anklicken zum Erweitern/Reduzieren. Zoomen und Verschieben mit Maus/Touch.</p>
    </div>

    <!-- UI Controls will be dynamically generated here -->
    <div id="controls-container" class="controls">
        <!-- JS will populate this -->
    </div>

    <!-- Container for the D3.js SVG visualization -->
    <div id="tree-container"></div>

    <!-- Tooltip element, hidden by default -->
    <div id="tooltip" class="tooltip">
        <div id="tooltip-name" class="name"></div>
        <div id="tooltip-details" class="details"></div>
    </div>

    <script>
        // The hierarchical data for the family tree.
        const familyData = {
          "name": "Johann Koller",
          "details": { "geboren": "1807", "gestorben": "02.09.1881", "info": "Heirat 1831 mit Franziska geb. Müller (1807-1892). 4 Kinder." },
          "children": [
            { "name": "Xaver Koller", "details": { "geboren": "24.11.1832", "gestorben": "13.04.1919" } },
            {
              "name": "Georg Koller",
              "details": { "geboren": "22.07.1843", "gestorben": "21.07.1928", "info": "Heirat 07.01.1873 mit Therese geb. Röck (1850-1923). 11 Kinder." },
              "children": [
                { "name": "Andreas Koller", "details": { "geboren": "1874", "gestorben": "1959", "info": "Heirat mit Therese Stadler. 6 Kinder." } },
                { "name": "Georg Koller", "details": { "geboren": "1876", "gestorben": "1954", "info": "Heirat mit Centa. 2 Kinder." } },
                { "name": "Franz Koller", "details": { "geboren": "1878", "gestorben": "1933", "info": "Heirat mit Anna Weikl. 14 Kinder." } },
                { "name": "Baptist Koller", "details": { "geboren": "1880", "gestorben": "1963", "info": "Heirat mit Berta Wenzl. 1 Kind." } },
                { "name": "Tobias Koller", "details": { "geboren": "1882", "gestorben": "1965", "info": "1. Ehe Cäzilia Weber (6 Kinder). 2. Ehe Maria Treml (10 Kinder)." } },
                { "name": "Willibald Koller", "details": { "geboren": "1883", "gestorben": "1964", "info": "Heirat mit Maria Egner. 12 Kinder." } },
                { "name": "Ludwig Koller", "details": { "geboren": "1886", "gestorben": "1974", "info": "Heirat mit Amalie Brandl. 6 Kinder." } },
                { "name": "Josef Koller", "details": { "geboren": "1888", "gestorben": "1958", "info": "Heirat mit Johanna Graßl. 8 Kinder." } },
                { "name": "Max Koller", "details": { "geboren": "1889", "gestorben": "1890" } },
                { "name": "Therese Treml", "details": { "geboren": "1890", "gestorben": "1976", "info": "geb. Koller. Heirat mit August Treml. 4 Kinder." } },
                {
                  "name": "Sylvester Koller",
                  "details": { "geboren": "23.07.1893", "gestorben": "24.03.1974", "info": "Heirat 06.03.1916 mit Mathilde geb. Hinkofer (1895-1974). 14 Kinder." },
                  "children": [
                    { "name": "Sylvester Koller", "details": { "geboren": "1917", "gestorben": "1937", "info": "Vom Blitz getroffen." } },
                    {
                      "name": "Wolfgang Koller",
                      "details": { "geboren": "1918", "gestorben": "1996", "info": "Heirat mit Rosina Adam. 6 Kinder." },
                      "children": [
                        { "name": "Renate Weikl", "details": { "geboren": "1944", "info": "Heirat mit Franz Xaver Weikl. 2 Kinder." } },
                        { "name": "Wolfgang Koller", "details": { "geboren": "1947", "info": "Heirat mit Marille Freimuth. 2 Kinder." } },
                        { "name": "Rupert Koller", "details": { "geboren": "1950", "info": "2 Ehen. 3 Kinder." } },
                        { "name": "Willibald S. Koller", "details": { "geboren": "1951", "info": "Heirat mit Paula Schlagintweit. 2 Kinder." } },
                        { "name": "Karl J. Koller", "details": { "geboren": "1955", "info": "Heirat mit Isolde Geiger. 1 Kind." } },
                        { "name": "Anton W. Koller", "details": { "geboren": "1959", "info": "Heirat mit Heidi Pöschl. 2 Kinder." } },
                      ]
                    },
                    { "name": "Maria Koller", "details": { "geboren": "1920", "gestorben": "1920" } },
                    { "name": "Alois Koller", "details": { "geboren": "1922", "gestorben": "1982", "info": "Partnerschaft mit Therese Brunner. Heirat mit Anna Drexler. 4 Kinder." } },
                    { "name": "Siegfried Koller", "details": { "geboren": "1923", "gestorben": "1981", "info": "Heirat mit Katharina Hutterer. 5 Kinder." } },
                    { "name": "Mathilde Wölfl", "details": { "geboren": "1925", "gestorben": "1980", "info": "Heirat mit Ernst Wölfl. 1 Kind." } },
                    { "name": "Friedrich Koller", "details": { "geboren": "1927", "gestorben": "1993", "info": "Heirat mit Rosa Tschada. 2 Kinder." } },
                    {
                      "name": "Maria Hubert",
                      "details": { "geboren": "1928", "info": "geb. Koller. Partnerschaft mit Franz Schreiner. Heirat mit Alfons Hubert. 4 Kinder." },
                      "children": [
                        {
                          "name": "Sylvester Koller",
                          "details": { "geboren": "1949", "info": "Heirat mit Christa Holl. 2 Kinder." },
                          "children": [
                            { "name": "Thomas Koller", "details": { "geboren": "1973", "gestorben": "2003" } },
                            {
                              "name": "Steffen Koller",
                              "details": { "geboren": "1975", "info": "Heirat 03.06.2011 mit Mareike Maier. 2 Kinder." },
                              "children": [
                                { "name": "Madita P. Koller", "details": { "geboren": "06.02.2013" } },
                                { "name": "Elva Koller", "details": { "geboren": "01.12.2014" } }
                              ]
                            }
                          ]
                        },
                        { "name": "Anton Koller", "details": { "geboren": "1952", "gestorben": "1954" } },
                        { "name": "Antonia R. Bauer", "details": { "geboren": "1958", "info": "Tochter von Maria Hubert. Heirat mit Otmar Bauer. 3 Kinder." } },
                        { "name": "Daniela M. Holl", "details": { "geboren": "1958", "info": "Tochter von Maria Hubert. Heirat mit Ernst Holl. 3 Kinder." } }
                      ]
                    },
                    { "name": "Lieselotte A. Koller", "details": { "geboren": "1929", "gestorben": "1930" } },
                    { "name": "Regina Bartimäß", "details": { "geboren": "1933", "info": "Heirat mit Günther Bartimäß. 3 Kinder." } },
                    { "name": "Therese Androwick", "details": { "geboren": "1934", "info": "Heirat mit William Androwick. 4 Kinder." } },
                    { "name": "Rita Wölfl", "details": { "geboren": "1937", "info": "Heirat mit Ernst Wölfl. 3 Kinder." } },
                    { "name": "Jakob Koller", "details": { "geboren": "1941", "gestorben": "2013", "info": "Heirat mit Rosa Neumeier. 4 Kinder." } },
                    { "name": "Franziska Rettenberger", "details": { "geboren": "1943", "info": "Heirat mit Josef Rettenberger. 2 Kinder." } }
                  ]
                }
              ]
            },
            { "name": "Katharina Haller", "details": { "geboren": "23.04.1845", "gestorben": "01.07.1914", "info": "geb. Koller. Heirat 10.11.1873 mit Franz-Xaver Haller (1842-1901)." } },
            { "name": "Franziska Stern", "details": { "geboren": "15.12.1863", "gestorben": "01.02.1927", "info": "geb. Koller. Heirat 25.06.1888 mit Michael Stern (1852-1929)." } },
          ]
        };

        // --- D3.js Visualization Code ---

        const width = window.innerWidth;
        const height = window.innerHeight;
        
        const treeLayout = d3.tree().nodeSize([150, 220]); // Increased spacing

        const svg = d3.select("#tree-container").append("svg")
            .attr("width", width)
            .attr("height", height);

        const g = svg.append("g");

        const tooltip = d3.select("#tooltip");
        const tooltipName = d3.select("#tooltip-name");
        const tooltipDetails = d3.select("#tooltip-details");

        const zoom = d3.zoom()
            .scaleExtent([0.1, 3])
            .on("zoom", (event) => {
                g.attr("transform", event.transform);
            });

        svg.call(zoom);

        let layoutSettings = {};
        let maxVisibleDepth = 2; // Default visible depth

        function findMaxDepth(node) {
            let max = node.depth;
            if (node.children) {
                node.children.forEach(child => {
                    max = Math.max(max, findMaxDepth(child));
                });
            }
            return max;
        }

        function getLayoutSettings() {
            const settings = {};
            d3.selectAll('.level-layout-switch').each(function() {
                settings[this.dataset.level] = this.value;
            });
            return settings;
        }

        function createLayoutControls(maxDepth) {
            const container = d3.select("#controls-container");
            container.html(''); // Clear

            // --- Depth Filter Control ---
            const depthGroup = container.append('div').attr('class', 'control-group');
            depthGroup.append('label').attr('for', 'depth-switch').text('Ebenen anzeigen:');
            const depthSelect = depthGroup.append('select')
                .attr('id', 'depth-switch')
                .on('change', function() {
                    maxVisibleDepth = parseInt(this.value);
                    setTreeVisibility(root, maxVisibleDepth);
                    update(root);
                });
            
            for (let i = 1; i <= maxDepth; i++) {
                depthSelect.append('option').attr('value', i).text(i)
                    .property('selected', i === maxVisibleDepth);
            }

            // --- Per-Level Layout Controls ---
            for (let i = 0; i < maxDepth; i++) {
                const controlGroup = container.append('div').attr('class', 'control-group');
                controlGroup.append('label').attr('for', `level-switch-${i}`).text(`Layout Ebene ${i+1}:`);
                controlGroup.append('select')
                    .attr('id', `level-switch-${i}`)
                    .attr('data-level', i)
                    .attr('class', 'level-layout-switch')
                    .on('change', function() {
                        layoutSettings = getLayoutSettings();
                        update(root);
                    })
                    .selectAll('option')
                    .data(['horizontal', 'vertical'])
                    .enter()
                    .append('option')
                    .attr('value', d => d)
                    .property("selected", d => d === 'horizontal')
                    .text(d => d === 'horizontal' ? 'Horizontal' : 'Vertikal');
            }
        }

        function setTreeVisibility(node, depth) {
            // Restore original children if they were hidden
            if (!node.children && node._children) {
                node.children = node._children;
            }
            
            if (node.depth >= depth) {
                // If node is at or beyond the desired depth, hide its children
                node.children = null;
            } else if (node._children) {
                // If node is within depth, ensure children are visible and recurse
                node.children = node._children;
                node.children.forEach(c => setTreeVisibility(c, depth));
            }
        }
        
        const tempRoot = d3.hierarchy(familyData);
        const maxDataDepth = findMaxDepth(tempRoot);
        createLayoutControls(maxDataDepth);
        layoutSettings = getLayoutSettings();

        const root = d3.hierarchy(familyData, d => d.children);
        root.x0 = width / 2;
        root.y0 = 0;

        root.descendants().forEach((d, i) => {
            d.id = i;
            d._children = d.children; // Store all potential children
        });
        
        setTreeVisibility(root, maxVisibleDepth);

        // --- Helper functions for collision detection ---
        function getTreeExtent(node) {
            let minX = node.x;
            let maxX = node.x;
            if (node.children) {
                node.children.forEach(child => {
                    const [childMinX, childMaxX] = getTreeExtent(child);
                    minX = Math.min(minX, childMinX);
                    maxX = Math.max(maxX, childMaxX);
                });
            }
            // Add a buffer for the node text in vertical layouts
            if (node.parent && layoutSettings[node.parent.depth] === 'vertical') {
                maxX += 100; // Approximate width of text
            }
            return [minX, maxX];
        }

        function shiftTree(node, shiftAmount) {
            node.x += shiftAmount;
            if (node.children) {
                node.children.forEach(child => shiftTree(child, shiftAmount));
            }
        }

        function update(source) {
            const duration = 500;
            
            // 1. Get a base horizontal layout.
            const treeData = treeLayout(root);
            let nodes = treeData.descendants();
            let links = treeData.links();

            // 2. Adjust for vertical layouts. This pass fixes the vertical overlap.
            nodes.forEach(parentNode => {
                if (!parentNode.children || layoutSettings[parentNode.depth] !== 'vertical') {
                    return;
                }
                const verticalNodeSpacing = { indent: 30, yGap: 50 };
                let lastY = parentNode.y;
                parentNode.children.forEach(childNode => {
                    childNode.x = parentNode.x + verticalNodeSpacing.indent;
                    lastY += verticalNodeSpacing.yGap;
                    childNode.y = lastY;
                });
            });

            // 3. Collision Resolution Pass. This fixes horizontal overlaps.
            root.eachAfter(node => {
                if (!node.children || layoutSettings[node.depth] !== 'horizontal') {
                    return;
                }
                const horizontalGap = 40;
                for (let i = 1; i < node.children.length; i++) {
                    const leftSubtree = node.children[i - 1];
                    const rightSubtree = node.children[i];
                    
                    const leftExtent = getTreeExtent(leftSubtree);
                    const rightExtent = getTreeExtent(rightSubtree);
                    
                    const shift = (leftExtent[1] - rightExtent[0]) + horizontalGap;
                    if (shift > 0) {
                        shiftTree(rightSubtree, shift);
                    }
                }
            });

            // 4. Render nodes and links
            const node = g.selectAll("g.node").data(nodes, d => d.id);

            const nodeEnter = node.enter().append("g")
                .attr("class", "node")
                .attr("transform", d => `translate(${source.x0},${source.y0})`)
                .on("click", click)
                .on("mouseover", mouseover)
                .on("mouseout", mouseout);

            nodeEnter.append("circle").attr("r", 1e-6);
            nodeEnter.append("text").text(d => d.data.name);

            const nodeUpdate = nodeEnter.merge(node);
            nodeUpdate.transition().duration(duration).attr("transform", d => `translate(${d.x},${d.y})`);
            
            nodeUpdate.select("text").transition().duration(duration)
                .attr("x", d => (!d.parent || layoutSettings[d.parent.depth] === 'horizontal') ? 0 : 15)
                .attr("y", d => (!d.parent || layoutSettings[d.parent.depth] === 'horizontal') ? 30 : 5)
                .attr("text-anchor", d => (!d.parent || layoutSettings[d.parent.depth] === 'horizontal') ? "middle" : "start");

            nodeUpdate.select("circle").attr("r", 10)
                .style("fill", d => d._children ? "#0ea5e9" : "#fff");

            const nodeExit = node.exit().transition().duration(duration)
                .attr("transform", d => `translate(${source.x},${source.y})`).remove();
            nodeExit.select("circle").attr("r", 1e-6);
            nodeExit.select("text").style("fill-opacity", 1e-6);

            const link = g.selectAll("path.link").data(links, d => d.target.id);

            const linkEnter = link.enter().insert("path", "g")
                .attr("class", "link")
                .attr("d", d => {
                    const o = { x: source.x0, y: source.y0, parent: source.parent };
                    return elbow(o, o);
                });

            linkEnter.merge(link).transition().duration(duration)
                .attr("d", d => elbow(d.source, d.target));

            link.exit().transition().duration(duration)
                .attr("d", d => {
                    const o = { x: source.x, y: source.y, parent: source.parent };
                    return elbow(o, o);
                }).remove();

            nodes.forEach(d => { d.x0 = d.x; d.y0 = d.y; });
        }

        function elbow(s, d) {
            if (!d.parent) return `M${s.x},${s.y}L${d.x},${d.y}`;
            const parentLayout = layoutSettings[d.parent.depth];
            if (parentLayout === 'vertical') {
                return `M${s.x},${s.y} L${s.x},${d.y} L${d.x},${d.y}`;
            }
            return `M${s.x},${s.y}V${(s.y + d.y) / 2}H${d.x}V${d.y}`;
        }

        function click(event, d) {
            if (d.children) {
                d._children = d.children;
                d.children = null;
            } else {
                d.children = d._children;
            }
            update(d);
        }
        
        function mouseover(event, d) {
            tooltip.transition().duration(200).style("opacity", .95);
            let detailsHTML = '';
            const details = d.data.details;
            if (details) {
                if (details.geboren || details.gestorben) {
                    detailsHTML += `<p><strong>Lebensdaten:</strong> ${details.geboren || '?'} - ${details.gestorben || '?'}</p>`;
                }
                if (details.info) {
                    detailsHTML += `<p class="mt-2"><strong>Info:</strong> ${details.info}</p>`;
                }
            }
            tooltipName.text(d.data.name);
            tooltipDetails.html(detailsHTML || 'Keine weiteren Details verfügbar.');
            tooltip.style("left", (event.pageX + 15) + "px")
                   .style("top", (event.pageY - 28) + "px");
        }

        function mouseout(event, d) {
            tooltip.transition().duration(500).style("opacity", 0);
        }

        update(root);
        
        const initialTransform = d3.zoomIdentity.translate(width / 2, 80).scale(0.6);
        svg.call(zoom.transform, initialTransform);

        window.addEventListener('resize', () => {
            svg.attr('width', window.innerWidth).attr('height', window.innerHeight);
        });

    </script>
</body>
</html>
