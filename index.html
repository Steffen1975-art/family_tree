<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interaktiver Stammbaum - Familien Koller & Holl & Maier</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* General body styling */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            color: #1e293b;
            margin: 0;
            overflow: hidden; /* Prevent body scrollbars */
        }

        /* SVG container styling */
        #tree-container {
            width: 100vw;
            height: 100vh;
            position: absolute;
            top: 0;
            left: 0;
        }

        /* Styling for the connecting lines (links) */
        .link {
            fill: none;
            stroke: #cbd5e1;
            stroke-width: 2px;
            transition: stroke 0.5s ease;
        }

        /* Styling for the person nodes */
        .node {
            cursor: pointer;
            font-size: 15px;
        }

        .node circle {
            stroke: #38bdf8;
            stroke-width: 2.5px;
            transition: fill 0.3s ease, transform 0.3s ease, stroke 0.3s ease;
        }
        
        /* Highlighting styles */
        .node.highlight circle {
            stroke: #f43f5e; /* Rose 500 for main selection */
            fill: #ffe4e6;
            stroke-width: 3px;
            transform: scale(1.2);
        }
        
        .node.descendant-highlight circle {
            stroke: #22c55e; /* Green 500 for descendants */
            fill: #dcfce7;
        }

        .link.descendant-highlight {
            stroke: #16a34a; /* Green 600 for descendant links */
            stroke-width: 3px;
        }

        .node text {
            font-weight: 500;
            paint-order: stroke;
            stroke: #f8fafc;
            stroke-width: 3.5px;
            stroke-linecap: butt;
            stroke-linejoin: miter;
        }
        
        .node:hover circle {
            transform: scale(1.1);
        }
        
        /* Controls Panel */
        .panel {
            position: absolute;
            top: 1rem;
            right: 1rem;
            z-index: 20;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .panel-header {
            padding: 0.75rem;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-header svg {
            width: 1.25rem;
            height: 1.25rem;
            transition: transform 0.3s ease;
        }

        .panel-content {
            padding: 0 0.75rem 0.75rem 0.75rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out, padding 0.3s ease-in-out;
            max-height: 1000px;
            opacity: 1;
            overflow: hidden;
        }

        .panel-content.collapsed {
            max-height: 0;
            opacity: 0;
            padding-top: 0;
            padding-bottom: 0;
        }

        .panel.collapsed .panel-header svg {
            transform: rotate(-90deg);
        }

        .panel .control-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .panel .control-row {
             display: flex;
             align-items: center;
             justify-content: space-between;
        }

        .panel label {
            margin-right: 0.75rem;
            font-size: 0.875rem;
            font-weight: 500;
            white-space: nowrap;
        }

        .panel select, .panel input[type="text"] {
            border-radius: 6px;
            border: 1px solid #d1d5db;
            padding: 0.25rem 0.5rem;
            width: 100%;
        }
        
        .panel button {
            width: 100%;
            padding: 0.5rem;
            border-radius: 6px;
            border: 1px solid transparent;
            background-color: #f3f4f6;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s, border-color 0.2s;
        }
        .panel button:hover {
            background-color: #e5e7eb;
        }
        .panel button.primary {
            background-color: #0ea5e9;
            color: white;
        }
        .panel button.primary:hover {
            background-color: #0284c7;
        }

        .view-switcher label {
            display: block;
            padding: 0.5rem;
            border-radius: 6px;
            cursor: pointer;
            text-align: center;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .view-switcher input[type="radio"] {
            display: none;
        }
        .view-switcher input[type="radio"]:checked + label {
            background-color: #38bdf8;
            color: white;
        }
        .view-switcher label:not(input[type="radio"]:checked + label):hover {
            background-color: #f1f5f9;
        }
        
        /* Search specific styles */
        .search-container {
            position: relative;
        }
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #d1d5db;
            border-top: none;
            border-radius: 0 0 6px 6px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 30;
        }
        .search-result-item {
            padding: 0.5rem;
            cursor: pointer;
        }
        .search-result-item:hover {
            background-color: #f1f5f9;
        }

        /* Tooltip */
        .tooltip {
            position: absolute;
            text-align: left;
            padding: 12px;
            font-size: 0.875rem;
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            max-width: 350px;
            z-index: 10;
        }
        .tooltip .name { font-weight: 700; color: #0c4a6e; font-size: 1rem; margin-bottom: 8px; }
        .tooltip .details p { margin: 4px 0; }
        .tooltip .details strong { color: #334155; }
    </style>
</head>
<body>

    <div class="absolute top-0 left-0 p-4 md:p-6 z-10 w-full bg-gradient-to-b from-white via-white/80 to-transparent pointer-events-none">
        <h1 id="main-title" class="text-2xl md:text-3xl font-bold text-sky-800">Ahnengalerie</h1>
        <p class="text-slate-600 mt-1 text-sm md:text-base">Ansicht wählen, Knoten anklicken, Zoomen & Verschieben.</p>
    </div>

    <div id="controls-container" class="panel">
        <!-- JS will populate this -->
    </div>

    <div id="tree-container"></div>

    <div id="tooltip" class="tooltip">
        <div id="tooltip-name" class="name"></div>
        <div id="tooltip-details" class="details"></div>
    </div>

    <script>
        // --- DATA SECTION ---
        // Single Source of Truth: All individuals in a flat array.
        // Relationships are handled by IDs (fatherId, motherId, spouseIds, childrenIds).
        const peopleData = [
            // =================================================
            // ============== KOLLER FAMILY LINE ===============
            // =================================================

            // --- Root Ancestors ---
            { id: 1, name: "Johann Koller", details: { geboren: "1807", gestorben: "02.09.1881", info: "Heirat 1831 mit Franziska geb. Müller." }, spouseIds: [2], childrenIds: [3, 4, 101, 102] },
            { id: 2, name: "Franziska Müller", details: { geboren: "1807", gestorben: "18.07.1892" } },
            
            // --- Children of Johann Koller (ID 1) ---
            { id: 3, name: "Xaver Koller", details: { geboren: "24.11.1832", gestorben: "13.04.1919" }, fatherId: 1, motherId: 2 },
            { id: 4, name: "Georg Koller", details: { geboren: "22.07.1843", gestorben: "21.07.1928", info: "Heirat 07.01.1873 mit Therese geb. Röck." }, fatherId: 1, motherId: 2, spouseIds: [5], childrenIds: [6, 110, 111, 112, 113, 114, 115, 116, 117, 118, 119] },
            { id: 101, name: "Katharina Haller (geb. Koller)", details: { geboren: "23.04.1845", gestorben: "01.07.1914", info: "Heirat 10.11.1873 mit Franz-Xaver Haller." }, fatherId: 1, motherId: 2, spouseIds: [1011] },
            { id: 1011, name: "Franz-Xaver Haller", details: { geboren: "12.11.1842", gestorben: "26.08.1901" } },
            { id: 102, name: "Franziska Stern (geb. Koller)", details: { geboren: "15.12.1863", gestorben: "01.02.1927", info: "Heirat 25.06.1888 mit Michael Stern." }, fatherId: 1, motherId: 2, spouseIds: [1021] },
            { id: 1021, name: "Michael Stern", details: { geboren: "14.07.1852", gestorben: "15.12.1929" } },

            // --- Family of Georg Koller (ID 4) ---
            { id: 5, name: "Therese Röck", details: { geboren: "23.03.1850", gestorben: "24.07.1923" } },

            // Children of Georg Koller (ID 4)
            { id: 6, name: "Andreas Koller", details: { geboren: "01.01.1874", gestorben: "10.05.1959", info: "Heirat 02.05.1898 mit Therese geb. Stadler." }, fatherId: 4, motherId: 5, spouseIds: [7], childrenIds: [8, 9, 10, 11, 12, 13] },
            { id: 110, name: "Georg Koller", details: { geboren: "26.02.1876", gestorben: "04.10.1954", info: "Heirat mit Centa (Daten unbekannt)." }, fatherId: 4, motherId: 5, spouseIds: [1100], childrenIds: [1101, 1102] },
            { id: 111, name: "Franz Koller", details: { geboren: "19.03.1878", gestorben: "09.11.1933", info: "Heirat 26.01.1902 mit Anna geb. Weikl." }, fatherId: 4, motherId: 5, spouseIds: [1110], childrenIds: [1111, 1112, 1113, 1114, 1115, 1116, 1117, 1118, 1119, 11110, 11111, 11112, 11113, 11114] },
            { id: 112, name: "Baptist Koller", details: { geboren: "20.06.1880", gestorben: "27.08.1963", info: "Heirat mit Berta geb. Wenzl." }, fatherId: 4, motherId: 5, spouseIds: [1120], childrenIds: [1121] },
            { id: 113, name: "Tobias Koller", details: { geboren: "10.09.1882", gestorben: "18.01.1965", info: "1. Ehe (24.09.1906) mit Cäzilia geb. Weber. 2. Ehe (22.04.1918) mit Maria Treml." }, fatherId: 4, motherId: 5, spouseIds: [11301, 11302], childrenIds: [1131, 1132, 1133, 1134, 1135, 1136, 1137, 1138, 1139, 11310, 11311, 11312, 11313, 11314, 11315, 11316] },
            { id: 114, name: "Willibald Koller", details: { geboren: "13.10.1883", gestorben: "15.11.1964", info: "Heirat 06.08.1906 mit Maria geb. Egner." }, fatherId: 4, motherId: 5, spouseIds: [1140] /* Children omitted for brevity */ },
            { id: 115, name: "Ludwig Koller", details: { geboren: "16.01.1886", gestorben: "26.01.1974", info: "Heirat 08.05.1911 mit Amalie geb. Brandl." }, fatherId: 4, motherId: 5, spouseIds: [1150] /* Children omitted for brevity */ },
            { id: 116, name: "Josef Koller", details: { geboren: "13.03.1888", gestorben: "30.10.1958", info: "Heirat 13.07.1920 mit Johanna geb. Graßl." }, fatherId: 4, motherId: 5, spouseIds: [1160] /* Children omitted for brevity */ },
            { id: 117, name: "Max Koller", details: { geboren: "20.04.1889", gestorben: "11.03.1890" }, fatherId: 4, motherId: 5 },
            { id: 118, name: "Therese Treml (geb. Koller)", details: { geboren: "12.08.1890", gestorben: "27.08.1976", info: "Heirat 1920 mit August Treml." }, fatherId: 4, motherId: 5, spouseIds: [1180] /* Children omitted for brevity */ },
            { id: 119, name: "Sylvester Koller", details: { geboren: "23.07.1893", gestorben: "24.03.1974", info: "Heirat 06.03.1916 mit Mathilde geb. Hinkofer." }, fatherId: 4, motherId: 5, spouseIds: [120], childrenIds: [121, 122, 123, 124, 125, 126, 127, 128, 129, 130, 131, 132, 133, 134] },

            // Grandchildren of Georg Koller (ID 4)
            // Family of Andreas Koller (ID 6)
            { id: 7, name: "Therese Stadler", details: { geboren: "30.05.1873", gestorben: "19.12.1960" } },
            { id: 8, name: "Therese Vogl (geb. Koller)", details: { geboren: "15.04.1899", gestorben: "20.03.1974", info: "Heirat 19.10.1921 mit Xaver Vogl." }, fatherId: 6, motherId: 7, spouseIds: [81] },
            { id: 81, name: "Xaver Vogl", details: { geboren: "12.09.1897", gestorben: "26.06.1958" } },
            { id: 9, name: "Andreas Koller", details: { geboren: "29.11.1902", gestorben: "14.04.1944", info: "Heirat 23.11.1925 mit Maria geb. Schreil." }, fatherId: 6, motherId: 7, spouseIds: [91] },
            { id: 91, name: "Maria Schreil", details: { geboren: "29.01.1901", gestorben: "24.09.1944" } },
            { id: 10, name: "Franz-Xaver Koller", details: { geboren: "20.05.1904", gestorben: "05.04.1962", info: "Heirat 22.10.1928 mit Thekla geb. Vogl." }, fatherId: 6, motherId: 7, spouseIds: [101] },
            { id: 101, name: "Thekla Vogl", details: { geboren: "21.05.1900", gestorben: "18.03.1974" } },
            { id: 11, name: "Franziska Koller", details: { geboren: "04.07.1906", gestorben: "unbekannt" }, fatherId: 6, motherId: 7 },
            { id: 12, name: "Maria Koller", details: { geboren: "06.12.1907", gestorben: "unbekannt" }, fatherId: 6, motherId: 7 },
            { id: 13, name: "Max Koller", details: { geboren: "25.09.1910", gestorben: "06.11.1937", info: "Heirat 24.05.1937 mit Johanna geb. Englmeier." }, fatherId: 6, motherId: 7, spouseIds: [131] },
            { id: 131, name: "Johanna Englmeier", details: { geboren: "04.07.1914", gestorben: "unbekannt" } },
            
            // Family of Georg Koller (ID 110)
            { id: 1100, name: "Centa Koller", details: { info: "Daten unbekannt." } },
            { id: 1101, name: "Georg Koller", details: { info: "Daten unbekannt." }, fatherId: 110, motherId: 1100 },
            { id: 1102, name: "Willibald Koller", details: { info: "Daten unbekannt." }, fatherId: 110, motherId: 1100 },
            
            // Family of Franz Koller (ID 111)
            { id: 1110, name: "Anna Weikl", details: { geboren: "30.05.1882", gestorben: "20.08.1928" } },
            { id: 1111, name: "Anna Wölfl (geb. Koller)", details: { geboren: "12.08.1902", gestorben: "12.08.1989", info: "Heirat 25.11.1926 mit Michael Wölfl." }, fatherId: 111, motherId: 1110 },
            { id: 1112, name: "Wilhelmine Kroner (geb. Koller)", details: { geboren: "29.09.1903", gestorben: "20.01.1988", info: "Heirat 16.11.1933 mit Johann Kroner." }, fatherId: 111, motherId: 1110 },
            { id: 1113, name: "Therese Weinberger (geb. Koller)", details: { geboren: "31.01.1905", gestorben: "28.02.1964", info: "Heirat 11.11.1926 mit Franz Weinberger." }, fatherId: 111, motherId: 1110 },
            { id: 1114, name: "Franz Koller", details: { geboren: "04.10.1906", gestorben: "vermisst 1945", info: "Heirat 04.02.1935 mit Veronika geb. Kroner." }, fatherId: 111, motherId: 1110 },
            { id: 1115, name: "Georg Koller", details: { geboren: "09.01.1908", gestorben: "24.09.1991", info: "Heirat 21.04.1958 mit Anna geb. Wühr." }, fatherId: 111, motherId: 1110 },
            { id: 1116, name: "Heinrich Koller", details: { geboren: "22.06.1909", gestorben: "04.05.1986" }, fatherId: 111, motherId: 1110 },
            { id: 1117, name: "Andreas Koller", details: { geboren: "15.10.1910", gestorben: "16.11.1944" }, fatherId: 111, motherId: 1110 },
            { id: 1118, name: "Ludwig Koller", details: { geboren: "24.08.1912", gestorben: "06.01.1976", info: "Heirat 07.02.1936 mit Wilhelmine geb. Stoiber." }, fatherId: 111, motherId: 1110 },
            { id: 1119, name: "Maria Koller", details: { geboren: "15.01.1914", gestorben: "22.10.1915" }, fatherId: 111, motherId: 1110 },
            { id: 11110, name: "Maria-Josefa Koller", details: { geboren: "17.09.1915" }, fatherId: 111, motherId: 1110 },
            { id: 11111, name: "Babette Koller", details: { geboren: "10.02.1917" }, fatherId: 111, motherId: 1110 },
            { id: 11112, name: "Rosa Koller", details: { geboren: "14.11.1918", gestorben: "09.05.1987" }, fatherId: 111, motherId: 1110 },
            { id: 11113, name: "Frieda Koller", details: { geboren: "18.06.1921" }, fatherId: 111, motherId: 1110 },
            { id: 11114, name: "Pauline Koller", details: { geboren: "16.11.1924" }, fatherId: 111, motherId: 1110 },

            // Family of Baptist Koller (ID 112)
            { id: 1120, name: "Berta Wenzl", details: { geboren: "11.12.1882", gestorben: "01.01.1961" } },
            { id: 1121, name: "Baptist Koller", details: { geboren: "20.07.1902", gestorben: "18.04.1972", info: "Heirat 01.10.1930 mit Sophie Hinkofer." }, fatherId: 112, motherId: 1120, spouseIds: [11211] },
            { id: 11211, name: "Sophie Hinkofer", details: { geboren: "15.11.1906", gestorben: "10.01.1987" } },

            // Family of Tobias Koller (ID 113)
            { id: 11301, name: "Cäzilia Weber", details: { geboren: "08.07.1883", gestorben: "13.12.1916" } },
            { id: 11302, name: "Maria Treml", details: { geboren: "11.09.1892", gestorben: "16.02.1980" } },
            { id: 1131, name: "Tobias Koller", details: { geboren: "22.05.1907", gestorben: "13.06.1922" }, fatherId: 113, motherId: 11301 },
            { id: 1132, name: "Cäzilia Koller", details: { geboren: "08.10.1908", gestorben: "13.07.1991" }, fatherId: 113, motherId: 11301 },
            { id: 1133, name: "Georg Koller", details: { geboren: "08.03.1910", gestorben: "14.09.1992" }, fatherId: 113, motherId: 11301 },
            { id: 1134, name: "Baptist Koller", details: { geboren: "26.05.1911", gestorben: "14.01.1912" }, fatherId: 113, motherId: 11301 },
            { id: 1135, name: "Michael Koller", details: { geboren: "28.09.1912", gestorben: "01.07.1999" }, fatherId: 113, motherId: 11301 },
            { id: 1136, name: "Therese Koller", details: { geboren: "21.11.1914", gestorben: "09.07.1915" }, fatherId: 113, motherId: 11301 },
            { id: 1137, name: "Johann-Baptist Koller", details: { geboren: "19.02.1919", gestorben: "vermisst 04.08.1942" }, fatherId: 113, motherId: 11302 },
            { id: 1138, name: "Maximilian Koller", details: { geboren: "16.10.1920", gestorben: "09.01.1980" }, fatherId: 113, motherId: 11302 },
            { id: 1139, name: "Josef Koller", details: { geboren: "25.02.1922", gestorben: "03.03.1997" }, fatherId: 113, motherId: 11302 },
            { id: 11310, name: "Maria Koller", details: { geboren: "15.05.1923", gestorben: "03.06.1924" }, fatherId: 113, motherId: 11302 },
            { id: 11311, name: "Maria Koller", details: { geboren: "16.08.1924", gestorben: "25.03.2013" }, fatherId: 113, motherId: 11302 },
            { id: 11312, name: "Berta Wurzer (geb. Koller)", details: { geboren: "13.08.1925" }, fatherId: 113, motherId: 11302 },
            { id: 11313, name: "Erwin Koller", details: { geboren: "19.03.1927", gestorben: "06.10.1927" }, fatherId: 113, motherId: 11302 },
            { id: 11314, name: "Elisabeth Koller", details: { geboren: "18.04.1928", gestorben: "27.12.1928" }, fatherId: 113, motherId: 11302 },
            { id: 11315, name: "August Koller", details: { geboren: "30.09.1929" }, fatherId: 113, motherId: 11302 },
            { id: 11316, name: "Reinhold Koller", details: { geboren: "16.05.1932", gestorben: "17.01.1933" }, fatherId: 113, motherId: 11302 },
            
            // Family of Willibald Koller (ID 114)
            { id: 1140, name: "Maria Egner", details: { geboren: "16.06.1882", gestorben: "09.02.1956" } },
            // Other families omitted for brevity, but structure is here
            { id: 1150, name: "Amalie Brandl", details: { geboren: "16.01.1887", gestorben: "31.05.1969" } },
            { id: 1160, name: "Johanna Graßl", details: { geboren: "07.02.1891", gestorben: "05.02.1970" } },
            { id: 1180, name: "August Treml", details: { geboren: "27.08.1896", gestorben: "10.01.1975" } },

            // Family of Sylvester Koller (ID 119)
            { id: 120, name: "Mathilde Hinkofer", details: { geboren: "28.12.1895", gestorben: "06.02.1974" } },
            { id: 121, name: "Sylvester Koller", details: { geboren: "07.02.1917", gestorben: "26.05.1937" }, fatherId: 119, motherId: 120 },
            { id: 122, name: "Wolfgang Koller", details: { geboren: "30.10.1918", gestorben: "04.02.1996", info: "Heirat 24.01.1946 mit Rosina geb. Adam." }, fatherId: 119, motherId: 120, spouseIds: [1221], childrenIds: [1222, 1223, 1224, 1225, 1226, 1227] },
            { id: 123, name: "Maria Koller", details: { geboren: "03.01.1920", gestorben: "16.03.1920" }, fatherId: 119, motherId: 120 },
            { id: 124, name: "Alois Koller", details: { geboren: "03.02.1922", gestorben: "04.05.1982" }, fatherId: 119, motherId: 120 },
            { id: 125, name: "Siegfried Koller", details: { geboren: "16.08.1923", gestorben: "01.07.1981" }, fatherId: 119, motherId: 120 },
            { id: 126, name: "Mathilde Wölfl (geb. Koller)", details: { geboren: "17.04.1925", gestorben: "24.10.1980" }, fatherId: 119, motherId: 120 },
            { id: 127, name: "Maria Hubert (geb. Koller)", details: { geboren: "19.04.1928", info: "Lebensgefährte Franz Xaver Schreiner. Heirat 10.05.1958 mit Alfons Georg Hubert." }, fatherId: 119, motherId: 120, spouseIds: [1271, 1272], childrenIds: [1273, 1274, 1275, 1276] },
            { id: 128, name: "Friedrich Koller", details: { geboren: "19.02.1927", gestorben: "13.01.1993" }, fatherId: 119, motherId: 120 },
            { id: 129, name: "Lieselotte Anna Koller", details: { geboren: "15.06.1929", gestorben: "05.03.1930" }, fatherId: 119, motherId: 120 },
            { id: 130, name: "Regina Bartimäß (geb. Koller)", details: { geboren: "06.09.1933" }, fatherId: 119, motherId: 120 },
            { id: 131, name: "Therese Androwick (geb. Koller)", details: { geboren: "15.10.1934" }, fatherId: 119, motherId: 120 },
            { id: 132, name: "Rita Wölfl (geb. Koller)", details: { geboren: "29.01.1937" }, fatherId: 119, motherId: 120 },
            { id: 133, name: "Jakob Koller", details: { geboren: "10.06.1941", gestorben: "18.03.2013" }, fatherId: 119, motherId: 120 },
            { id: 134, name: "Franziska Rettenberger (geb. Koller)", details: { geboren: "01.01.1943" }, fatherId: 119, motherId: 120 },
            
            // Great-Grandchildren of Georg Koller (ID 4) -> Family of Wolfgang Koller (ID 122)
            { id: 1221, name: "Rosina Adam", details: { geboren: "28.03.1922", gestorben: "16.09.1999" } },
            { id: 1222, name: "Renate Franziska Weikl (geb. Adam)", details: { geboren: "13.12.1944" }, fatherId: null, motherId: 1221 }, // Note: Adopted or from previous relationship
            { id: 1223, name: "Wolfgang Koller", details: { geboren: "06.03.1947" }, fatherId: 122, motherId: 1221 },
            { id: 1224, name: "Rupert Koller", details: { geboren: "26.05.1950" }, fatherId: 122, motherId: 1221 },
            { id: 1225, name: "Willibald Siegfried Koller", details: { geboren: "01.12.1951" }, fatherId: 122, motherId: 1221 },
            { id: 1226, name: "Karl Josef Koller", details: { geboren: "13.11.1955" }, fatherId: 122, motherId: 1221 },
            { id: 1227, name: "Anton Wilhelm Koller", details: { geboren: "02.07.1959" }, fatherId: 122, motherId: 1221 },

            // --- CENTRAL PEOPLE & MERGE POINT ---
            { id: 1271, name: "Franz Xaver Schreiner", details: { geboren: "15.11.1919", gestorben: "12.08.1972" } },
            { id: 1272, name: "Alfons Georg Hubert", details: { geboren: "04.09.1907", gestorben: "16.06.1997" } },
            { id: 1273, name: "Sylvester Koller", details: { geboren: "08.04.1949", info: "Sohn von Franz Schreiner. Heirat 08.09.1972 mit Christa Koller (geb. Holl)." }, fatherId: 1271, motherId: 127, spouseIds: [200], childrenIds: [201, 202] },
            { id: 1274, name: "Anton Koller", details: { geboren: "08.01.1952", gestorben: "28.03.1954" }, fatherId: 1271, motherId: 127 },
            { id: 1275, name: "Antonia Rita Bauer (geb. Hubert)", details: { geboren: "27.12.1958" }, fatherId: 1272, motherId: 127 },
            { id: 1276, name: "Daniela M. Holl (geb. Hubert)", details: { geboren: "27.12.1958", info: "Heirat 10.05.1979 (geschieden) mit Ernst Holl." }, fatherId: 1272, motherId: 127, spouseIds: [212], childrenIds: [12761, 12762, 12763] },
            
            // Children of Daniela Holl (ID 1276)
            { id: 12761, name: "Carolin Irene Binder (geb. Holl)", details: { geboren: "24.10.1979" }, fatherId: 212, motherId: 1276 },
            { id: 12762, name: "Susanne Christa Casper (geb. Holl)", details: { geboren: "27.01.1981" }, fatherId: 212, motherId: 1276 },
            { id: 12763, name: "Michaela Wieser (geb. Holl)", details: { geboren: "24.11.1983" }, fatherId: 212, motherId: 1276 },

            // Children of Sylvester Koller (ID 1273)
            { id: 201, name: "Thomas Koller", details: { geboren: "12.08.1973", gestorben: "13.11.2003" }, fatherId: 1273, motherId: 200 },
            { id: 202, name: "Steffen Koller", details: { geboren: "09.08.1975", info: "Heirat 03.06.2011 mit Mareike Koller (geb. Maier)." }, fatherId: 1273, motherId: 200, spouseIds: [300], childrenIds: [301, 302, 303, 304] },
            
            // Children of Steffen Koller (ID 202)
            { id: 301, name: "Madita Pauline Koller", details: { geboren: "06.02.2013" }, fatherId: 202, motherId: 300 },
            { id: 302, name: "Elva Koller", details: { geboren: "01.12.2014" }, fatherId: 202, motherId: 300 },
            { id: 303, name: "Lida Koller", details: { geboren: "24.01.2018" }, fatherId: 202, motherId: 300 },
            { id: 304, name: "Tore Koller", details: { geboren: "03.09.2020" }, fatherId: 202, motherId: 300 },

            // =================================================
            // ================ HOLL FAMILY LINE ===============
            // =================================================
            { id: 205, name: "Georg Holl", details: { geboren: "15.06.1874", gestorben: "28.02.1947", info: "1. Heirat 21.04.1904 mit Pauline geb. Betz. 2. Heirat 20.05.1918 mit Pauline geb. Vollmer." }, spouseIds: [206, 207], childrenIds: [2051, 2052, 208, 209, 2053, 210, 2054, 2055, 2056, 2057, 2058, 2059] },
            { id: 206, name: "Pauline Betz", details: { geboren: "11.07.1881", gestorben: "12.02.1918" } },
            { id: 207, name: "Pauline Vollmer", details: { geboren: "25.10.1885", gestorben: "28.09.1965" } },

            // Children of Georg Holl (ID 205)
            { id: 2051, name: "Pauline Holl", details: { geboren: "28.09.1904", gestorben: "21.12.1906" }, fatherId: 205, motherId: 206 },
            { id: 2052, name: "Klara Holl", details: { geboren: "29.10.1905", gestorben: "26.08.1906" }, fatherId: 205, motherId: 206 },
            { id: 208, name: "Hermann Holl", details: { geboren: "13.09.1906", gestorben: "01.02.1979", info: "Aus 1. Ehe. Heirat 24.06.1940 mit Anna geb. Sparrer." }, fatherId: 205, motherId: 206 },
            { id: 209, name: "Karl Holl", details: { geboren: "03.01.1908", gestorben: "03.12.1987", info: "Aus 1. Ehe." }, fatherId: 205, motherId: 206 },
            { id: 2053, name: "Maria Holl", details: { geboren: "22.05.1909", gestorben: "02.05.1910" }, fatherId: 205, motherId: 206 },
            { id: 210, name: "Ernst Holl", details: { geboren: "21.06.1910", gestorben: "24.10.1974", info: "Aus 1. Ehe. Heirat 25.01.1946 mit Anna geb. Fischer." }, fatherId: 205, motherId: 206, spouseIds: [211], childrenIds: [212, 213, 200, 214, 215] },
            { id: 2054, name: "Maria Holl", details: { geboren: "13.10.1911", gestorben: "31.12.1911" }, fatherId: 205, motherId: 206 },
            { id: 2055, name: "Eugen Holl", details: { geboren: "02.12.1911", gestorben: "14.02.2008" }, fatherId: 205, motherId: 206 },
            { id: 2056, name: "Klara Fischer (geb. Holl)", details: { geboren: "28.06.1914", gestorben: "02.04.1959", info: "Aus 1. Ehe." }, fatherId: 205, motherId: 206 },
            { id: 2057, name: "Emilie Stähle (geb. Holl)", details: { geboren: "15.07.1919", gestorben: "18.08.2012", info: "Aus 2. Ehe." }, fatherId: 205, motherId: 207 },
            { id: 2058, name: "Otto Holl", details: { geboren: "27.01.1921", gestorben: "26.01.2000", info: "Aus 2. Ehe." }, fatherId: 205, motherId: 207 },
            { id: 2059, name: "Pauline Kleinbach (geb. Holl)", details: { geboren: "04.06.1922", info: "Aus 2. Ehe." }, fatherId: 205, motherId: 207 },

            // Family of Ernst Holl (ID 210)
            { id: 211, name: "Anna Fischer", details: { geboren: "04.08.1923", gestorben: "27.11.2004" } },
            { id: 212, name: "Ernst Holl", details: { geboren: "03.12.1946", info: "Heirat 12.05.1979 mit Daniela M. Holl (geb. Hubert)." }, fatherId: 210, motherId: 211, spouseIds: [1276] },
            { id: 213, name: "Gerhard Holl", details: { geboren: "31.03.1949", gestorben: "11.02.2012" }, fatherId: 210, motherId: 211 },
            { id: 200, name: "Christa Koller (geb. Holl)", details: { geboren: "07.11.1951", gestorben: "08.10.2012", info: "Heirat 08.09.1972 mit Sylvester Koller." }, fatherId: 210, motherId: 211, spouseIds: [1273], childrenIds: [201, 202] },
            { id: 214, name: "Irene Holl", details: { geboren: "27.04.1953", gestorben: "17.02.2007" }, fatherId: 210, motherId: 211 },
            { id: 215, name: "Martin Holl", details: { geboren: "10.11.1958", gestorben: "Juni 1959" }, fatherId: 210, motherId: 211 },
            
            // =================================================
            // =============== MAIER FAMILY LINE ===============
            // =================================================
            { id: 305, name: "Reinhold & Rose Mögenthaler", details: { info: "Eltern von Dagmar und Rose." }, childrenIds: [310, 312] },
            { id: 306, name: "Ernst & Berta Maier", details: { info: "Eltern von Erwin und Wolfgang." }, childrenIds: [313, 314] },

            { id: 310, name: "Dagmar Maier (geb. Mögenthaler)", details: { info: "verh. mit Rolf Maier" }, fatherId: 305, spouseIds: [311], childrenIds: [300] },
            { id: 311, name: "Rolf Maier", details: { info: "Sohn von Erwin Maier." }, fatherId: 313 },
            { id: 312, name: "Rose Maier (geb. Mögenthaler)", details: { info: "verh. mit Wolfgang Maier" }, fatherId: 305, spouseIds: [314] },
            { id: 313, name: "Erwin Maier", details: { info: "verh. mit Elfriede" }, fatherId: 306, childrenIds: [311] },
            { id: 314, name: "Wolfgang Maier", details: { info: "verh. mit Rose Mögenthaler" }, fatherId: 306, spouseIds: [312] },
            
            { id: 300, name: "Mareike Koller (geb. Maier)", details: { geboren: "18.11.1981", info: "Heirat 03.06.2011 mit Steffen Koller." }, fatherId: 311, motherId: 310, spouseIds: [202], childrenIds: [301, 302, 303, 304] },
        ];

        // --- D3.js Visualization Code ---
        
        // Global variables
        let svg, g, zoom, tooltip, tooltipName, tooltipDetails;
        let root, flatData, selectedNode, initialTransform;
        let allPeopleMap = new Map();
        let maxVisibleDepth = 1;
        const width = window.innerWidth;
        const height = window.innerHeight;
        const treeLayout = d3.tree().nodeSize([160, 220]);

        // --- DATA PROCESSING ---

        /**
         * Initializes the master data map from the flat array.
         */
        function initializeMasterData() {
            allPeopleMap.clear();
            peopleData.forEach(p => {
                // Ensure details object exists
                if (!p.details) p.details = {};
                allPeopleMap.set(p.id, { ...p, children: [], _children: [] });
            });
        }

        /**
         * Builds a hierarchical tree structure from the flat data for a given root person ID.
         * @param {number} rootId - The ID of the person to start the tree from.
         * @param {Map} personMap - The map of all people.
         * @param {Set} visited - A set to track visited nodes and prevent infinite loops.
         * @returns {object|null} A hierarchical object suitable for d3.hierarchy.
         */
        function buildTreeFromFlatData(rootId, personMap, visited = new Set()) {
            if (visited.has(rootId)) {
                console.warn("Circular dependency detected for ID:", rootId);
                return null; // Avoid circular dependencies
            }
            visited.add(rootId);

            const rootPerson = personMap.get(rootId);
            if (!rootPerson) {
                return null;
            }

            // Create a deep copy to avoid modifying the original map data
            const treeNode = JSON.parse(JSON.stringify(rootPerson));
            treeNode.children = [];

            if (rootPerson.childrenIds) {
                rootPerson.childrenIds.forEach(childId => {
                    const childNode = buildTreeFromFlatData(childId, personMap, new Set(visited));
                    if (childNode) {
                        treeNode.children.push(childNode);
                    }
                });
            }
            return treeNode;
        }

        /**
         * Generates an ancestor tree (Ahnentafel) for a given person ID.
         * @param {number} startId - The ID of the person to start from.
         * @param {Map} personMap - The map of all people.
         * @param {number} maxDepth - The maximum number of generations to go back.
         * @returns {object|null} A hierarchical object representing the ancestor tree.
         */
        function generateAhnentafel(startId, personMap, maxDepth = 10) {
            const visited = new Set();
            function buildAncestors(personId, depth) {
                if (!personId || depth > maxDepth || visited.has(personId)) {
                    return null;
                }
                visited.add(personId);
                const person = personMap.get(personId);
                if (!person) return null;

                const ahnenNode = {
                    id: person.id, // Ensure ID is part of the node data
                    name: person.name,
                    data: person, // Keep original data reference
                    details: person.details,
                    children: []
                };

                const father = buildAncestors(person.fatherId, depth + 1);
                const mother = buildAncestors(person.motherId, depth + 1);

                if (father) ahnenNode.children.push(father);
                if (mother) ahnenNode.children.push(mother);
                
                // Add spouse(s) as non-hierarchical info for the tooltip, not as children
                if (person.spouseIds && person.spouseIds.length > 0) {
                    ahnenNode.spouseInfo = person.spouseIds.map(id => personMap.get(id)?.name).filter(Boolean).join(', ');
                }

                return ahnenNode;
            }
            return buildAncestors(startId, 1);
        }
        
        /**
         * Finds the root view key ('koller', 'holl', 'maier') for a given person ID.
         * This helps in switching to the correct tree upon search.
         * @param {number} personId - The ID of the person to find the root for.
         * @returns {string|null} The view key or null if not found.
         */
        function findRootViewKey(personId) {
            const rootIdMap = { 1: 'koller', 205: 'holl', 305: 'maier' };
            let current = allPeopleMap.get(personId);
            const visited = new Set(); // Prevent infinite loops
            
            while (current) {
                if (rootIdMap[current.id]) {
                    return rootIdMap[current.id];
                }
                if (visited.has(current.id)) {
                    return null; // Cycle detected
                }
                visited.add(current.id);

                // Traverse up the tree. Prefer father's line, then mother's.
                let parentId = current.fatherId || current.motherId;
                if (parentId) {
                    current = allPeopleMap.get(parentId);
                } else {
                    // This person might be a root themselves but not one of the main ones, or an orphan node.
                    // Check if they are a spouse of someone in a tree.
                    const spouseOf = peopleData.find(p => p.spouseIds?.includes(current.id));
                    if (spouseOf) {
                        current = allPeopleMap.get(spouseOf.id); // Try to trace from the spouse
                    } else {
                        break; // No more parents to check
                    }
                }
            }
            return null; // Not found in any main tree
        }


        // --- VISUALIZATION SETUP ---

        function initializeVisualization() {
            d3.select("#tree-container").html('');
            
            svg = d3.select("#tree-container").append("svg")
                .attr("width", width)
                .attr("height", height);

            g = svg.append("g");

            tooltip = d3.select("#tooltip");
            tooltipName = d3.select("#tooltip-name");
            tooltipDetails = d3.select("#tooltip-details");

            zoom = d3.zoom()
                .scaleExtent([0.1, 3])
                .on("zoom", (event) => {
                    g.attr("transform", event.transform);
                });

            svg.call(zoom);
        }
        
        // --- UI CONTROLS ---

        function createControls(maxDepth) {
            const container = d3.select("#controls-container");
            container.html(''); 

            const header = container.append('div').attr('class', 'panel-header');
            header.append('span').text('Ansicht & Steuerung');
            header.append('svg').attr('viewBox', '0 0 20 20').attr('fill', 'currentColor')
              .html(`<path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />`);
            
            const content = container.append('div').attr('class', 'panel-content');

            header.on('click', () => {
                container.classed('collapsed', !container.classed('collapsed'));
                content.classed('collapsed', !content.classed('collapsed'));
            });

            const viewGroup = content.append('div').attr('class', 'control-group');
            viewGroup.append('label').text('Ansicht wählen:');
            const viewSwitcher = viewGroup.append('div').attr('class', 'view-switcher grid grid-cols-2 sm:grid-cols-4 gap-1');
            
            viewSwitcher.append('div').html('<input type="radio" id="view-koller" name="view" value="koller" checked><label for="view-koller">Koller</label>');
            viewSwitcher.append('div').html('<input type="radio" id="view-holl" name="view" value="holl"><label for="view-holl">Holl</label>');
            viewSwitcher.append('div').html('<input type="radio" id="view-maier" name="view" value="maier"><label for="view-maier">Maier</label>');
            viewSwitcher.append('div').html('<input type="radio" id="view-ahnentafel" name="view" value="ahnentafel"><label for="view-ahnentafel">Ahnentafel</label>');

            d3.selectAll('input[name="view"]').on('change', function() {
                renderTree(this.value);
            });

            const searchGroup = content.append('div').attr('class', 'control-group mt-2 search-container').attr('id', 'search-container');
            searchGroup.append('label').attr('for', 'search-input').text('Person suchen:');
            searchGroup.append('input')
                .attr('type', 'text')
                .attr('id', 'search-input')
                .attr('placeholder', 'Name eingeben...');
            searchGroup.append('div').attr('class', 'search-results');

            const depthGroup = content.append('div').attr('class', 'control-group mt-2').attr('id', 'depth-control');
            const depthRow = depthGroup.append('div').attr('class', 'control-row');
            depthRow.append('label').attr('for', 'depth-switch').text('Ebenen anzeigen:');
            const depthSelect = depthRow.append('select').attr('id', 'depth-switch')
                .on('change', function() {
                    maxVisibleDepth = parseInt(this.value);
                    setTreeVisibility(root, maxVisibleDepth);
                    update(root);
                });
            
            for (let i = 1; i <= maxDepth; i++) {
                depthSelect.append('option').attr('value', i).text(i)
                    .property('selected', i === maxVisibleDepth);
            }
            
            const buttonGroup = content.append('div').attr('class', 'control-group mt-2 flex-col space-y-2');
            buttonGroup.append('button').attr('id', 'reset-button').text('Ansicht zurücksetzen');
            buttonGroup.append('button').attr('id', 'zoom-button').text('Auf Auswahl zoomen').attr('class', 'primary');

            d3.select('#search-input').on('input', handleSearch);
            d3.select('#reset-button').on('click', handleReset);
            d3.select('#zoom-button').on('click', handleZoomToSelection);
        }
        
        // --- D3 UPDATE LOGIC ---
        
        function setTreeVisibility(node, depth) {
            if (!node) return;
            if (node.depth >= depth) {
                if (node.children) {
                    node._children = node.children;
                    node.children = null;
                }
            } else {
                if (node._children) {
                    node.children = node._children;
                    node._children = null;
                }
                if (node.children) {
                    node.children.forEach(c => setTreeVisibility(c, depth));
                }
            }
        }

        function findMaxDepth(node) {
            if (!node) return 0;
            let max = node.depth || 0;
            const children = node.children || node._children;
            if (children) {
                children.forEach(child => {
                    max = Math.max(max, findMaxDepth(child));
                });
            }
            return max;
        }

        function update(source) {
            const duration = 500;
            
            const treeData = treeLayout(root);
            let nodes = treeData.descendants();
            let links = treeData.links();

            const node = g.selectAll("g.node").data(nodes, d => d.data.id || d.data.name); // Use person ID for data binding

            const nodeEnter = node.enter().append("g")
                .attr("class", "node")
                .attr("transform", d => `translate(${source.x0},${source.y0})`)
                .on("click", (event, d) => click(event, d))
                .on("mouseover", (event, d) => mouseover(event, d.data))
                .on("mouseout", mouseout);

            nodeEnter.append("circle").attr("r", 1e-6);
            nodeEnter.append("text").text(d => d.data.name);

            const nodeUpdate = nodeEnter.merge(node);
            nodeUpdate.transition().duration(duration).attr("transform", d => `translate(${d.x},${d.y})`);
            
            nodeUpdate.select("text").transition().duration(duration)
                .attr("x", 0)
                .attr("y", 30)
                .attr("text-anchor", "middle");

            nodeUpdate.select("circle").transition().duration(duration).attr("r", 10)
                .style("fill", d => d._children ? "#0ea5e9" : "#fff");
            
            const nodeExit = node.exit().transition().duration(duration)
                .attr("transform", d => `translate(${source.x},${source.y})`).remove();
            nodeExit.select("circle").attr("r", 1e-6);
            nodeExit.select("text").style("fill-opacity", 1e-6);

            const link = g.selectAll("path.link").data(links, d => d.target.data.id || d.target.data.name);

            const linkEnter = link.enter().insert("path", "g")
                .attr("class", "link")
                .attr("d", d => {
                    const o = { x: source.x0, y: source.y0 };
                    return elbow(o, o);
                });

            linkEnter.merge(link).transition().duration(duration)
                .attr("d", d => elbow(d.source, d.target));

            link.exit().transition().duration(duration)
                .attr("d", d => {
                    const o = { x: source.x, y: source.y };
                    return elbow(o, o);
                }).remove();
            
            highlightBranch(selectedNode);
            nodes.forEach(d => { d.x0 = d.x; d.y0 = d.y; });
        }
        
        function elbow(s, d) {
            return `M${s.x},${s.y}V${(s.y + d.y) / 2}H${d.x}V${d.y}`;
        }

        function highlightBranch(d) {
            d3.selectAll('.node').classed('highlight descendant-highlight', false);
            d3.selectAll('.link').classed('descendant-highlight', false);

            if (!d) return;

            const descendantNodes = d.descendants();
            const descendantIds = new Set(descendantNodes.map(n => n.data.id));

            d3.selectAll('.node').each(function(node_d) {
                if(!node_d.data.id) return;
                const isDescendant = descendantIds.has(node_d.data.id);
                d3.select(this).classed('highlight', node_d.data.id === d.data.id);
                d3.select(this).classed('descendant-highlight', isDescendant && node_d.data.id !== d.data.id);
            });

            d3.selectAll('.link').each(function(link_d) {
                if(!link_d.source.data.id || !link_d.target.data.id) return;
                const isDescendantLink = descendantIds.has(link_d.source.data.id) && descendantIds.has(link_d.target.data.id);
                d3.select(this).classed('descendant-highlight', isDescendantLink);
            });
        }

        // --- EVENT HANDLERS ---

        function click(event, d) {
            // Prevent click from propagating to svg zoom
            event.stopPropagation();
            
            if (d.children) {
                d._children = d.children;
                d.children = null;
                selectedNode = d.parent; // Select parent when collapsing
            } else {
                d.children = d._children;
                d._children = null;
                selectedNode = d; // Select current node when expanding
            }
            highlightBranch(selectedNode);
            update(d);
        }
        
        function mouseover(event, d) {
            tooltip.transition().duration(200).style("opacity", .95);
            let detailsHTML = '';
            const details = d.details;
            if (details) {
                if (details.geboren || details.gestorben) {
                    detailsHTML += `<p><strong>Lebensdaten:</strong> ${details.geboren || '?'} - ${details.gestorben || '?'}</p>`;
                }
                if (d.spouseInfo) { // For Ahnentafel view
                     detailsHTML += `<p><strong>Partner:</strong> ${d.spouseInfo}</p>`;
                }
                if (details.info) {
                    detailsHTML += `<p class="mt-2"><strong>Info:</strong> ${details.info}</p>`;
                }
            }
            tooltipName.text(d.name);
            tooltipDetails.html(detailsHTML || 'Keine weiteren Details verfügbar.');
            
            const tooltipWidth = tooltip.node().offsetWidth;
            const tooltipHeight = tooltip.node().offsetHeight;
            let left = event.pageX + 15;
            let top = event.pageY - 28;
            if (left + tooltipWidth > window.innerWidth) {
                left = event.pageX - tooltipWidth - 15;
            }
            if (top + tooltipHeight > window.innerHeight) {
                top = event.pageY - tooltipHeight;
            }
            tooltip.style("left", left + "px").style("top", top + "px");
        }

        function mouseout(event, d) {
            tooltip.transition().duration(500).style("opacity", 0);
        }

        function showPathAndCenter(d) {
            selectedNode = d;
            let ancestors = d.ancestors();
            
            // Collapse all nodes except the direct path to the selected node
            root.descendants().forEach(node => {
                if (ancestors.indexOf(node) < 0 && node.children) {
                    node._children = node.children;
                    node.children = null;
                }
            });

            // Expand the direct path to the selected node
            ancestors.forEach(anc => {
                if(anc._children) {
                    anc.children = anc._children;
                    anc._children = null;
                }
            });

            update(root); // Use root to redraw the whole structure

            setTimeout(() => {
                const scale = 0.8;
                const transform = d3.zoomIdentity
                    .translate(width / 2 - d.x * scale, height / 2 - d.y * scale)
                    .scale(scale);
                
                svg.transition().duration(750).call(zoom.transform, transform);
                highlightBranch(d);
            }, 550); // Delay to allow for update transition
        }

        function handleSearch(event) {
            const inputElement = this;
            const value = inputElement.value.toLowerCase();
            const resultsContainer = d3.select(inputElement.parentNode).select('.search-results');
            resultsContainer.html('');

            if (value.length < 2) return;

            const results = peopleData
                .filter(p => p.name.toLowerCase().includes(value))
                .map(p => ({ displayName: p.name, targetId: p.id }));
            
            const uniqueResults = Array.from(new Map(results.map(item => [item.displayName, item])).values());

            uniqueResults.forEach(res => {
                resultsContainer.append('div')
                    .attr('class', 'search-result-item')
                    .text(res.displayName)
                    .on('click', () => {
                        const targetId = res.targetId;
                        const currentView = d3.select('input[name="view"]:checked').node().value;
                        
                        // Logic for Ahnentafel view
                        if (currentView === 'ahnentafel') {
                            const ahnentafelData = generateAhnentafel(targetId, allPeopleMap);
                            if (ahnentafelData) {
                                renderTree('ahnentafel', ahnentafelData, targetId);
                            }
                        } else {
                            // Logic for Stammbaum views
                            const viewKey = findRootViewKey(targetId);
                            if (viewKey) {
                                if (currentView !== viewKey) {
                                    // Switch view and then select
                                    renderTree(viewKey, null, targetId);
                                } else {
                                    // Already in correct view, just select
                                    const targetNode = root.descendants().find(n => n.data.id === targetId);
                                    if (targetNode) {
                                        showPathAndCenter(targetNode);
                                    }
                                }
                            } else {
                                console.log(`Person with ID ${targetId} not found in any main tree.`);
                            }
                        }
                        
                        resultsContainer.html('');
                        inputElement.value = '';
                    });
            });
        }
        
        function handleReset() {
            const currentView = d3.select('input[name="view"]:checked').node().value;
            renderTree(currentView);
        }

        function handleZoomToSelection() {
            if (selectedNode) {
                const scale = 0.8;
                const transform = d3.zoomIdentity
                    .translate(width / 2 - selectedNode.x * scale, height / 2 - selectedNode.y * scale)
                    .scale(scale);
                svg.transition().duration(750).call(zoom.transform, transform);
            }
        }

        // --- MAIN RENDER FUNCTION ---

        function renderTree(viewKey, customData = null, targetIdToSelect = null) {
            let data, title;
            const rootIds = { koller: 1, holl: 205, maier: 305 };
            const titles = { koller: "Stammbaum Familie Koller", holl: "Stammbaum Familie Holl", maier: "Stammbaum Familie Maier" };
            
            const searchLabel = d3.select('#search-container label');
            const depthControl = d3.select('#depth-control');

            if (viewKey === 'ahnentafel') {
                title = "Ahnentafel";
                if(searchLabel.node()) searchLabel.text('Ahnentafel für:');
                if(depthControl.node()) depthControl.style('display', 'none');

                if (customData) {
                    data = customData;
                    title = `Ahnentafel ${data.name}`;
                } else {
                    // Default to my (Steffen Koller's) ancestor chart
                    data = generateAhnentafel(202, allPeopleMap);
                    title = `Ahnentafel ${data.name}`;
                }
            } else {
                if(searchLabel.node()) searchLabel.text('Person suchen:');
                if(depthControl.node()) depthControl.style('display', 'flex');
                
                data = buildTreeFromFlatData(rootIds[viewKey], allPeopleMap);
                title = titles[viewKey];
            }
            d3.select('#main-title').text(title);

            initializeVisualization();
            
            selectedNode = null;
            maxVisibleDepth = (viewKey === 'ahnentafel') ? 10 : 2; 

            if (!data) {
                console.error("No data available for view:", viewKey);
                g.append("text").attr("x", width/2).attr("y", height/2).attr("text-anchor", "middle").text("Daten für diese Ansicht nicht verfügbar.");
                return;
            }

            root = d3.hierarchy(data, d => d.children);
            
            // FIX: Calculate max depth directly from the hierarchy object.
            // Do not use JSON.stringify on an object with circular references.
            const maxDataDepth = findMaxDepth(root) || 5;
            
            createControls(maxDataDepth);
            
            d3.select(`#view-${viewKey}`).property('checked', true);
            d3.select('#depth-switch').property('value', maxVisibleDepth);
            if (viewKey === 'ahnentafel') {
                d3.select('#depth-control').style('display', 'none');
            }

            root.x0 = width / 2;
            root.y0 = 0;
            
            // Collapse all nodes beyond the initial visible depth
            root.descendants().forEach(d => {
                if (d.depth >= maxVisibleDepth) {
                    d._children = d.children;
                    d.children = null;
                }
            });
            
            flatData = root.descendants();
            
            update(root);
            
            const yOffset = (viewKey === 'ahnentafel') ? height / 2 : 120;
            const scale = (viewKey === 'ahnentafel') ? 0.6 : 0.7;
            initialTransform = d3.zoomIdentity.translate(width / 2, yOffset).scale(scale);
            svg.call(zoom.transform, initialTransform);

            // If a specific node needs to be selected after rendering
            if (targetIdToSelect) {
                setTimeout(() => {
                    const targetNode = root.descendants().find(n => n.data.id === targetIdToSelect);
                    if (targetNode) {
                        showPathAndCenter(targetNode);
                    }
                }, 100); // Small delay for rendering
            }
        }

        // --- Initial Setup ---
        initializeMasterData();
        renderTree('koller');

        window.addEventListener('resize', () => {
            const currentView = d3.select('input[name="view"]:checked').node().value;
            renderTree(currentView);
        });

    </script>
</body>
</html>
